{% extends "base.html" %}

{% block content %}
<h2 class="my-4">Список задач</h2>

<table class="table table-striped table-hover sortable">
    <thead>
        <tr>
            <th onclick="sortTable(0)" style="cursor: pointer;">№</th>
            <th onclick="sortTable(1)" style="cursor: pointer;">Заказчик</th>
            <th onclick="sortTable(2)" style="cursor: pointer;">Менеджер</th>
            <th onclick="sortTable(3)" style="cursor: pointer;">Тип продукции</th>
            <th onclick="sortTable(4)" style="cursor: pointer;">Количество</th>
            <th onclick="sortTable(5)" style="cursor: pointer;">Материал</th>
            <th class="no-sort">Листы</th>
            <th onclick="sortTable(7)" style="cursor: pointer;">Срочность</th>
            <th onclick="sortTable(8)" style="cursor: pointer;">Статус</th>
            <th class="no-sort">Статус цехов</th>
            <th onclick="sortTable(10)" style="cursor: pointer;">Дата создания</th>
            <th onclick="sortTable(11)" style="cursor: pointer;">Дата завершения</th>
            <th class="no-sort">Действия</th>
        </tr>
    </thead>
    <tbody>
        {% for task in tasks %}
        <tr onclick="window.location='/task/{{ task.id }}'" style="cursor: pointer;">
            <td>{{ task.task_number }}</td>
            <td>{{ task.customer }}</td>
            <td>{{ task.manager }}</td>
            <td>{{ task.product }}</td>
            <td>{{ task.quantity }}</td>
            <td>{{ task.material }}</td>
            <td>
                {% if task.sheets %}
                    <ul class="mb-0 ps-3">
                        {% for sheet in task.sheets.split(";") %}
                            <li>{{ sheet }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <span class="text-muted">—</span>
                {% endif %}
            </td>
            <td>{{ task.urgency }}</td>
            <td>{{ task.status }}</td>
            <td>
                <ul class="mb-0 ps-3">
                    {% for workshop in task.workshops_status %}
                        <li><strong>{{ workshop.workshop_name }}:</strong> {{ workshop.workshop_status }}</li>
                    {% endfor %}
                </ul>
            </td>
            <td>{{ task.created_at }}</td>
            <td>{{ task.completed_at }}</td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteTask({{ task.id }})">Удалить</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Скрипт сортировки -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    window.sortTable = function(n) {
        const table = document.querySelector("table.sortable");
        const headers = table.querySelectorAll("th");

        if (headers[n].classList.contains("no-sort")) return;

        let dir = headers[n].dataset.sortDir === "asc" ? "desc" : "asc";
        let rows = Array.from(table.tBodies[0].rows);

        headers.forEach((h, i) => {
            h.classList.remove("sorted-asc", "sorted-desc");
            if (i === n) h.classList.add(`sorted-${dir}`);
            h.dataset.sortDir = i === n ? dir : "";
        });

        rows.sort((a, b) => {
            let x = a.cells[n].innerText.trim().toLowerCase();
            let y = b.cells[n].innerText.trim().toLowerCase();

            const isNumber = !isNaN(parseFloat(x)) && !isNaN(parseFloat(y));
            if (isNumber) {
                x = parseFloat(x);
                y = parseFloat(y);
            }

            if (x < y) return dir === "asc" ? -1 : 1;
            if (x > y) return dir === "asc" ? 1 : -1;
            return 0;
        });

        rows.forEach(row => table.tBodies[0].appendChild(row));
    };
});

// Отменяем переход по строке, если клик был на <th> или <button>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("table.sortable tbody tr").forEach(row => {
        row.addEventListener("click", (e) => {
            if (e.target.tagName === "TH" || e.target.closest("button")) return;
            const taskId = row.querySelector("button").getAttribute("onclick").match(/\d+/)[0];
            window.location.href = `/task/${taskId}`;
        });
    });
});

function deleteTask(taskId) {
    if (!confirm("Удалить задачу?")) return;

    fetch(`/task/${taskId}/delete`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
    })
    .then(response => {
        if (!response.ok) throw new Error("Ошибка при удалении");
        return response.json();
    })
    .then(data => {
        showMessage(data.message || "Удалено");
        const row = document.querySelector(`button[onclick="deleteTask(${taskId})"]`).closest("tr");
        if (row) row.remove();
    })
    .catch(error => {
        console.error("❌ Ошибка:", error);
        showMessage("Произошла ошибка при удалении", "error");
    });
}

function showMessage(message, type = "success") {
    const box = document.createElement("div");
    box.className = `alert alert-${type === 'error' ? 'danger' : 'success'}`;
    box.textContent = message;
    document.body.prepend(box);
    setTimeout(() => box.remove(), 3000);
}
</script>
<style>
th[onclick] {
    cursor: pointer;
    user-select: none;
}
th.sorted-asc::after { content: " ↑"; }
th.sorted-desc::after { content: " ↓"; }
</style>
    
{% endblock %}
